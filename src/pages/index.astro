---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import CategoryNav from '../components/CategoryNav.astro';
import ArticleCard from '../components/ArticleCard.astro';
import AddFeed from '../components/AddFeed.astro';
import WhatsNewBanner from '../components/WhatsNewBanner.astro';
import { fetchAllFeeds } from '../lib/feeds';
import { getDayLabel } from '../lib/utils';

const allItems = await fetchAllFeeds();
const articles = allItems.filter(item => item.mediaType !== 'video');

// Group articles by day
const dayGroups = new Map<string, typeof articles>();
for (const article of articles) {
  const label = getDayLabel(article.pubDate);
  if (!dayGroups.has(label)) {
    dayGroups.set(label, []);
  }
  dayGroups.get(label)!.push(article);
}
---

<Layout title="RSS Reader">
  <Header />
  <WhatsNewBanner />
  <CategoryNav />

  <main class="container">
    <div class="article-list">
      {[...dayGroups.entries()].map(([dayLabel, dayArticles], index) => (
        <section class="day-group" data-day-index={index} hidden={index >= 3}>
          <h2 class="day-label">{dayLabel}</h2>
          {dayArticles.map((article) => (
            <ArticleCard
              id={article.id}
              title={article.title}
              link={article.link}
              pubDate={article.pubDate}
              summary={article.summary}
              feedUrl={article.feedUrl}
              feedTitle={article.feedTitle}
              feedFavicon={article.feedFavicon}
              category={article.category}
              categorySlug={article.categorySlug}
              readingTime={article.readingTime}
            />
          ))}
        </section>
      ))}

      {dayGroups.size > 3 && (
        <div class="load-more-container">
          <button id="load-more-btn" class="btn-secondary load-more-btn">
            Show older ({dayGroups.size - 3} more days)
          </button>
        </div>
      )}
    </div>

    <AddFeed />
  </main>

  <script>
    // Hide feeds the user has removed
    import { getCustomFeeds, getHiddenFeeds } from '../lib/customFeeds';
    import { escapeHtml } from '../lib/utils';

    const hiddenUrls = new Set(getHiddenFeeds());
    if (hiddenUrls.size > 0) {
      document.querySelectorAll<HTMLElement>('.article-card[data-feed-url]').forEach((card) => {
        if (hiddenUrls.has(card.dataset.feedUrl!)) {
          card.remove();
        }
      });
    }

    // Load custom feeds client-side
    async function loadCustomFeeds() {
      const customFeeds = getCustomFeeds().filter((f) => !hiddenUrls.has(f.url));
      if (customFeeds.length === 0) return;

      try {
        const response = await fetch('/.netlify/functions/fetch-custom-feeds', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(customFeeds),
        });

        if (!response.ok) return;

        const articles = await response.json();
        if (articles.length === 0) return;

        // Insert custom feed articles into the page
        const articleList = document.querySelector('.article-list');
        if (!articleList) return;

        for (const article of articles) {
          const card = document.createElement('article');
          card.className = 'article-card';
          card.setAttribute(
            'data-searchable',
            [article.title, article.feedTitle, article.category, article.summary]
              .filter(Boolean)
              .join(' '),
          );

          const date = new Date(article.pubDate);
          const timeAgo = formatTimeAgo(date);

          card.innerHTML = `
            <h3 class="article-title">
              <a href="${escapeHtml(article.link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(article.title)}</a>
            </h3>
            <div class="article-meta">
              <span>${escapeHtml(article.feedTitle)}</span>
              <span class="separator">&middot;</span>
              <time datetime="${date.toISOString()}">${timeAgo}</time>
              <span class="separator">&middot;</span>
              <span class="category-tag">${escapeHtml(article.category)}</span>
            </div>
            ${article.summary ? `<p class="article-summary">${escapeHtml(article.summary).slice(0, 160)}</p>` : ''}
          `;

          // Find the right day group or create one
          const firstGroup = articleList.querySelector('.day-group');
          if (firstGroup) {
            const dayArticles = firstGroup.querySelector('.article-card:last-of-type');
            if (dayArticles) {
              dayArticles.after(card);
            } else {
              firstGroup.appendChild(card);
            }
          }
        }
      } catch {
        // Silently fail for custom feeds
      }
    }

    function formatTimeAgo(date: Date): string {
      const diffMs = Date.now() - date.getTime();
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;

      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    loadCustomFeeds();

    // Saved articles filter (activated via /#saved)
    import { getAllBookmarks } from '../lib/bookmarks';

    function applySavedFilter() {
      const isSaved = window.location.hash === '#saved';
      const savedLink = document.querySelector('.saved-link');

      if (isSaved) {
        const bookmarks = new Set(getAllBookmarks());
        document.querySelectorAll<HTMLElement>('.article-card[data-article-id]').forEach((card) => {
          card.style.display = bookmarks.has(card.dataset.articleId!) ? '' : 'none';
        });
        document.querySelectorAll<HTMLElement>('.day-group').forEach((group) => {
          const visible = group.querySelectorAll('.article-card:not([style*="display: none"])');
          group.style.display = visible.length > 0 ? '' : 'none';
        });
        if (savedLink) savedLink.classList.add('active-nav');
      } else {
        document.querySelectorAll<HTMLElement>('.article-card[data-article-id]').forEach((card) => {
          card.style.display = '';
        });
        document.querySelectorAll<HTMLElement>('.day-group').forEach((group) => {
          group.style.display = '';
        });
        if (savedLink) savedLink.classList.remove('active-nav');
      }
    }

    applySavedFilter();
    window.addEventListener('hashchange', applySavedFilter);

    // Progressive loading of day groups
    const loadMoreBtn = document.getElementById('load-more-btn');
    if (loadMoreBtn) {
      const LOAD_INCREMENT = 5;
      let currentlyVisible = 3;
      const allDayGroups = document.querySelectorAll<HTMLElement>('.day-group[data-day-index]');
      const totalDays = allDayGroups.length;

      loadMoreBtn.addEventListener('click', () => {
        const nextBatch = Math.min(currentlyVisible + LOAD_INCREMENT, totalDays);
        for (let i = currentlyVisible; i < nextBatch; i++) {
          allDayGroups[i].hidden = false;
        }
        currentlyVisible = nextBatch;

        const remaining = totalDays - currentlyVisible;
        if (remaining <= 0) {
          loadMoreBtn.style.display = 'none';
        } else {
          loadMoreBtn.textContent = `Show older (${remaining} more day${remaining === 1 ? '' : 's'})`;
        }
      });
    }
  </script>
</Layout>
