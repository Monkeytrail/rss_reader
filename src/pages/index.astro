---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import CategoryNav from '../components/CategoryNav.astro';
import ArticleCard from '../components/ArticleCard.astro';
import AddFeed from '../components/AddFeed.astro';
import WhatsNewBanner from '../components/WhatsNewBanner.astro';
import { fetchAllFeeds } from '../lib/feeds';
import { getDayLabel } from '../lib/utils';

const allItems = await fetchAllFeeds();
const articles = allItems.filter(item => item.mediaType !== 'video');

// Group articles by day
const dayGroups = new Map<string, typeof articles>();
for (const article of articles) {
  const label = getDayLabel(article.pubDate);
  if (!dayGroups.has(label)) {
    dayGroups.set(label, []);
  }
  dayGroups.get(label)!.push(article);
}
---

<Layout title="RSS Reader">
  <Header />
  <WhatsNewBanner />
  <CategoryNav />

  <main class="container">
    <div class="article-list">
      {[...dayGroups.entries()].map(([dayLabel, dayArticles], index) => (
        <section class="day-group" data-day-index={index} hidden={index >= 3}>
          <h2 class="day-label">{dayLabel}</h2>
          {dayArticles.map((article) => (
            <ArticleCard
              id={article.id}
              title={article.title}
              link={article.link}
              pubDate={article.pubDate}
              summary={article.summary}
              feedUrl={article.feedUrl}
              feedTitle={article.feedTitle}
              feedFavicon={article.feedFavicon}
              category={article.category}
              categorySlug={article.categorySlug}
              readingTime={article.readingTime}
            />
          ))}
        </section>
      ))}

      {dayGroups.size > 3 && (
        <div class="load-more-container">
          <button id="load-more-btn" class="btn-secondary load-more-btn">
            Show older ({dayGroups.size - 3} more days)
          </button>
        </div>
      )}
    </div>

    <AddFeed />
  </main>

  <script>
    // Saved articles filter (activated via /#saved)
    import { getAllBookmarks } from '../lib/bookmarks';

    function applySavedFilter() {
      const isSaved = window.location.hash === '#saved';
      const savedLink = document.querySelector('.saved-link');

      if (isSaved) {
        const bookmarks = new Set(getAllBookmarks());
        document.querySelectorAll<HTMLElement>('.article-card[data-article-id]').forEach((card) => {
          card.style.display = bookmarks.has(card.dataset.articleId!) ? '' : 'none';
        });
        document.querySelectorAll<HTMLElement>('.day-group').forEach((group) => {
          const visible = group.querySelectorAll('.article-card:not([style*="display: none"])');
          group.style.display = visible.length > 0 ? '' : 'none';
        });
        if (savedLink) savedLink.classList.add('active-nav');
      } else {
        document.querySelectorAll<HTMLElement>('.article-card[data-article-id]').forEach((card) => {
          card.style.display = '';
        });
        document.querySelectorAll<HTMLElement>('.day-group').forEach((group) => {
          group.style.display = '';
        });
        if (savedLink) savedLink.classList.remove('active-nav');
      }
    }

    applySavedFilter();
    window.addEventListener('hashchange', applySavedFilter);

    // Progressive loading of day groups
    const loadMoreBtn = document.getElementById('load-more-btn');
    if (loadMoreBtn) {
      const LOAD_INCREMENT = 5;
      let currentlyVisible = 3;
      const allDayGroups = document.querySelectorAll<HTMLElement>('.day-group[data-day-index]');
      const totalDays = allDayGroups.length;

      loadMoreBtn.addEventListener('click', () => {
        const nextBatch = Math.min(currentlyVisible + LOAD_INCREMENT, totalDays);
        for (let i = currentlyVisible; i < nextBatch; i++) {
          allDayGroups[i].hidden = false;
        }
        currentlyVisible = nextBatch;

        const remaining = totalDays - currentlyVisible;
        if (remaining <= 0) {
          loadMoreBtn.style.display = 'none';
        } else {
          loadMoreBtn.textContent = `Show older (${remaining} more day${remaining === 1 ? '' : 's'})`;
        }
      });
    }
  </script>
</Layout>
