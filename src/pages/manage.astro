---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import { getFeedMetadata, getFeedErrors } from '../lib/feeds';
import feedsConfig from '../data/feeds.json';

const feeds = await getFeedMetadata();
const feedErrors = await getFeedErrors();

// Group feed metadata by category (preserving feeds.json order)
const feedsByCategory = new Map<string, typeof feeds>();
for (const cat of feedsConfig.categories) {
  const catFeeds = feeds.filter((f) => f.categorySlug === cat.slug);
  if (catFeeds.length > 0) {
    feedsByCategory.set(cat.name, catFeeds);
  }
}

function formatLastSeen(date: Date | null): string {
  if (!date) return 'Never';

  const days = Math.floor((Date.now() - date.getTime()) / 86400000);

  if (days === 0) return 'Today';
  if (days === 1) return 'Yesterday';
  if (days < 7) return `${days} days ago`;
  if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
  if (days < 365) return `${Math.floor(days / 30)} months ago`;
  return `${Math.floor(days / 365)} years ago`;
}
---

<Layout title="Manage Feeds - RSS Reader">
  <Header />

  <main class="manage-page container">
    <h1>Manage Feeds</h1>

    {feedErrors.length > 0 && (
      <section class="feed-errors-section">
        <h2>Feed Errors ({feedErrors.length})</h2>
        <p class="section-description">These feeds failed to load during the last build.</p>
        <ul class="feed-list">
          {feedErrors.map((err) => (
            <li class="feed-item feed-error-item">
              <div class="feed-info">
                <span class="feed-title">{err.title}</span>
                <span class="feed-meta">{err.category}</span>
                <code class="feed-error-message">{err.error}</code>
              </div>
              <a href={err.url} target="_blank" rel="noopener noreferrer" class="btn-secondary">Check</a>
            </li>
          ))}
        </ul>
      </section>
    )}

    <div id="hidden-feeds-section" class="hidden-feeds-section" hidden>
      <h2>Hidden feeds (<span id="hidden-count">0</span>)</h2>
      <p class="section-description">These feeds are hidden from your article list.</p>
      <ul id="hidden-feeds-list" class="feed-list"></ul>
    </div>

    {[...feedsByCategory.entries()].map(([categoryName, catFeeds]) => (
      <section class="feed-category-section">
        <h2>{categoryName} <span class="feed-count">({catFeeds.length})</span></h2>
        <ul class="feed-list">
          {catFeeds.map((feed) => (
            <li class="feed-item" data-feed-url={feed.url} style={feed.isQuiet ? 'border-left: 3px solid rgba(255,200,0,0.6); padding-left: 0.5rem; background: rgba(255,200,0,0.02); border-radius: 4px; opacity: 0.6;' : ''}>
              <img src={feed.faviconUrl} alt="" class="feed-icon" width="16" height="16" loading="lazy" />
              <div class="feed-info">
                <span class="feed-title">{feed.title}</span>
                <span class="feed-meta">
                  {formatLastSeen(feed.lastArticleDate)}
                  {feed.articleCount > 0 && ` \u00b7 ${feed.articleCount} items`}
                  {feed.isQuiet && ' \u00b7 Quiet'}
                </span>
              </div>
              <button class="remove-feed" data-url={feed.url} aria-label={`Remove ${feed.title}`}>&times;</button>
            </li>
          ))}
        </ul>
      </section>
    ))}

    <section id="custom-feeds-section" class="feed-category-section">
      <h2>Custom <span id="custom-count" class="feed-count">(0)</span></h2>
      <ul id="custom-feeds-list" class="feed-list"></ul>
    </section>

    <section class="add-feed-section">
      <h2>Add Feed</h2>
      <form id="add-feed-form" class="add-feed-form visible">
        <div class="form-row">
          <div class="form-group form-group-grow">
            <label for="feed-url">Feed URL</label>
            <input
              type="url"
              id="feed-url"
              name="url"
              placeholder="https://example.com/feed.xml"
              required
            />
          </div>
          <div class="form-group">
            <label for="feed-title">Title (optional)</label>
            <input
              type="text"
              id="feed-title"
              name="title"
              placeholder="Auto-detected"
            />
          </div>
          <div class="form-group">
            <label for="feed-category">Category</label>
            <input type="text" id="feed-category" name="category" value="Custom" list="categories" />
            <datalist id="categories">
              {[...feedsByCategory.keys()].map((name) => (
                <option value={name} />
              ))}
            </datalist>
          </div>
          <div class="form-group form-group-btn">
            <button type="submit" class="btn-primary">Add</button>
          </div>
        </div>
        <p class="form-note">Custom feeds are saved locally in your browser.</p>
      </form>
    </section>

    <section class="feed-health-section">
      <h2>Feed Health</h2>
      <p class="section-description">Reliability over recent builds.</p>
      <div id="health-loading" class="feed-meta">Loading health data...</div>
      <div id="health-dashboard" hidden></div>
    </section>

    <section class="manage-actions">
      <h2>Import / Export</h2>
      <div class="opml-buttons">
        <button id="export-opml" class="btn-secondary">Export OPML</button>
        <label for="opml-upload" class="btn-secondary upload-label">Import OPML</label>
        <input type="file" id="opml-upload" accept=".opml,.xml" hidden />
      </div>
      <div id="import-preview"></div>
    </section>
  </main>
</Layout>

<script>
  import {
    getCustomFeeds,
    removeCustomFeed,
    addCustomFeed,
    getHiddenFeeds,
    hideFeed,
    unhideFeed,
    exportCustomFeedsAsOPML,
  } from '../lib/customFeeds';

  // --- Hidden feeds ---
  function renderHiddenFeeds() {
    const hidden = getHiddenFeeds();
    const section = document.getElementById('hidden-feeds-section')!;
    const list = document.getElementById('hidden-feeds-list')!;
    const count = document.getElementById('hidden-count')!;

    if (hidden.length === 0) {
      section.hidden = true;
      return;
    }

    section.hidden = false;
    count.textContent = String(hidden.length);

    list.innerHTML = hidden
      .map(
        (url) => `
        <li class="feed-item">
          <div class="feed-info">
            <span class="feed-meta"><code>${url}</code></span>
          </div>
          <button class="restore-feed btn-secondary" data-url="${url}">Restore</button>
        </li>
      `,
      )
      .join('');

    list.querySelectorAll('.restore-feed').forEach((btn) => {
      btn.addEventListener('click', () => {
        unhideFeed((btn as HTMLElement).dataset.url!);
        // Show the feed item again in the main list
        const feedItem = document.querySelector(`.feed-item[data-feed-url="${(btn as HTMLElement).dataset.url}"]`);
        if (feedItem) (feedItem as HTMLElement).hidden = false;
        renderHiddenFeeds();
      });
    });
  }

  // Mark already-hidden feeds in the server-rendered list
  const hiddenUrls = new Set(getHiddenFeeds());
  document.querySelectorAll<HTMLElement>('.feed-item[data-feed-url]').forEach((item) => {
    if (hiddenUrls.has(item.dataset.feedUrl!)) {
      item.hidden = true;
    }
  });

  // Attach remove handlers to default feed items
  document.querySelectorAll<HTMLElement>('.remove-feed[data-url]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const url = btn.dataset.url!;
      hideFeed(url);
      const feedItem = btn.closest<HTMLElement>('.feed-item');
      if (feedItem) feedItem.hidden = true;
      renderHiddenFeeds();
    });
  });

  renderHiddenFeeds();

  // --- Custom feeds ---
  function renderCustomFeeds() {
    const customFeeds = getCustomFeeds();
    const list = document.getElementById('custom-feeds-list')!;
    const count = document.getElementById('custom-count')!;
    const section = document.getElementById('custom-feeds-section')!;

    count.textContent = `(${customFeeds.length})`;

    if (customFeeds.length === 0) {
      list.innerHTML = '<li class="feed-item"><p class="empty">No custom feeds added yet.</p></li>';
      return;
    }

    list.innerHTML = customFeeds
      .map(
        (feed) => `
        <li class="feed-item">
          <img src="https://www.google.com/s2/favicons?domain=${new URL(feed.url).hostname}&sz=32" alt="" class="feed-icon" width="16" height="16" loading="lazy" />
          <div class="feed-info">
            <span class="feed-title">${feed.title}</span>
            <span class="feed-meta">${feed.category} &middot; <code>${feed.url}</code></span>
          </div>
          <button class="remove-feed" data-custom-id="${feed.id}" aria-label="Remove ${feed.title}">&times;</button>
        </li>
      `,
      )
      .join('');

    list.querySelectorAll('.remove-feed[data-custom-id]').forEach((btn) => {
      btn.addEventListener('click', () => {
        removeCustomFeed((btn as HTMLElement).dataset.customId!);
        renderCustomFeeds();
      });
    });
  }

  renderCustomFeeds();

  // --- Add feed form ---
  const form = document.getElementById('add-feed-form') as HTMLFormElement;
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const url = formData.get('url') as string;
    let title = formData.get('title') as string;
    const category = (formData.get('category') as string) || 'Custom';

    if (!title) {
      try {
        const response = await fetch(
          `/.netlify/functions/fetch-feed-info?url=${encodeURIComponent(url)}`,
        );
        if (response.ok) {
          const data = await response.json();
          title = data.title || new URL(url).hostname;
        }
      } catch {
        title = new URL(url).hostname;
      }
    }

    addCustomFeed(url, title, category);
    form.reset();
    (document.getElementById('feed-category') as HTMLInputElement).value = 'Custom';
    renderCustomFeeds();
  });

  // --- Export OPML ---
  document.getElementById('export-opml')?.addEventListener('click', () => {
    const opml = exportCustomFeedsAsOPML();
    const blob = new Blob([opml], { type: 'application/xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'custom-feeds.opml';
    a.click();
    URL.revokeObjectURL(url);
  });

  // --- Import OPML ---
  document.getElementById('opml-upload')?.addEventListener('change', async (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (!file) return;

    const text = await file.text();
    const preview = document.getElementById('import-preview')!;

    // Parse feeds from OPML
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'application/xml');
    const outlines = doc.querySelectorAll('outline[xmlUrl]');

    const feeds: { title: string; url: string; category: string }[] = [];
    outlines.forEach((outline) => {
      const url = outline.getAttribute('xmlUrl')!;
      const title = outline.getAttribute('title') || outline.getAttribute('text') || new URL(url).hostname;
      const parent = outline.parentElement;
      const category = parent?.tagName === 'outline'
        ? (parent.getAttribute('title') || parent.getAttribute('text') || 'Custom')
        : 'Custom';
      feeds.push({ title, url, category });
    });

    if (feeds.length === 0) {
      preview.innerHTML = '<p>No feeds found in this OPML file.</p>';
      return;
    }

    // Show preview with import button
    const existingUrls = new Set(getCustomFeeds().map((f) => f.url));
    const newFeeds = feeds.filter((f) => !existingUrls.has(f.url));

    preview.innerHTML = `
      <p>Found ${feeds.length} feed${feeds.length === 1 ? '' : 's'}${newFeeds.length < feeds.length ? ` (${feeds.length - newFeeds.length} already added)` : ''}.</p>
      ${newFeeds.length > 0 ? `<button id="confirm-import" class="btn-primary">Import ${newFeeds.length} feed${newFeeds.length === 1 ? '' : 's'}</button>` : '<p class="section-description">All feeds already imported.</p>'}
    `;

    document.getElementById('confirm-import')?.addEventListener('click', () => {
      for (const feed of newFeeds) {
        addCustomFeed(feed.url, feed.title, feed.category);
      }
      preview.innerHTML = `<p>Imported ${newFeeds.length} feed${newFeeds.length === 1 ? '' : 's'}.</p>`;
      renderCustomFeeds();
    });

    // Reset file input so the same file can be re-selected
    (e.target as HTMLInputElement).value = '';
  });

  // Feed Health Dashboard
  async function loadFeedHealth() {
    try {
      const response = await fetch('/.netlify/functions/get-feed-health');
      if (!response.ok) throw new Error('Failed');

      const healthData: Record<string, { status: string; errorMessage: string | null }[]> = await response.json();
      const dashboard = document.getElementById('health-dashboard')!;
      const loading = document.getElementById('health-loading')!;

      loading.hidden = true;
      dashboard.hidden = false;

      if (Object.keys(healthData).length === 0) {
        dashboard.innerHTML = '<p class="feed-meta">No health data yet. Data appears after the first build with Turso configured.</p>';
        return;
      }

      // Only show feeds with issues
      const issues: string[] = [];
      for (const [feedUrl, snapshots] of Object.entries(healthData)) {
        const recent = snapshots.slice(0, 5);
        const errorCount = recent.filter((s) => s.status === 'error').length;
        const quietCount = recent.filter((s) => s.status === 'quiet').length;

        if (errorCount === 0 && quietCount === 0) continue;

        let cls = 'health-quiet';
        let msg = 'No recent articles';
        if (errorCount >= 3) {
          cls = 'health-critical';
          msg = `Failed ${errorCount} of last ${recent.length} builds`;
        } else if (errorCount > 0) {
          cls = 'health-warning';
          msg = `${errorCount} error${errorCount === 1 ? '' : 's'} in last ${recent.length} builds`;
        }

        const feedItem = document.querySelector<HTMLElement>(`.feed-item[data-feed-url="${CSS.escape(feedUrl)}"]`);
        const title = feedItem?.querySelector('.feed-title')?.textContent || new URL(feedUrl).hostname;

        issues.push(`<div class="health-item ${cls}"><span class="health-dot"></span><span class="health-title">${title}</span><span class="health-status">${msg}</span></div>`);
      }

      if (issues.length === 0) {
        dashboard.innerHTML = '<p class="feed-meta">All feeds healthy across recent builds.</p>';
      } else {
        dashboard.innerHTML = `<div class="health-grid">${issues.join('')}</div>`;
      }
    } catch {
      document.getElementById('health-loading')!.textContent = 'Health data unavailable.';
    }
  }

  loadFeedHealth();
</script>
