---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import { getFeedMetadata } from '../lib/feeds';

const feeds = await getFeedMetadata();
const quietFeeds = feeds.filter((f) => f.isQuiet);
const activeFeeds = feeds.filter((f) => !f.isQuiet);

function formatLastSeen(date: Date | null): string {
  if (!date) return 'Never';

  const days = Math.floor((Date.now() - date.getTime()) / 86400000);

  if (days === 0) return 'Today';
  if (days === 1) return 'Yesterday';
  if (days < 7) return `${days} days ago`;
  if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
  if (days < 365) return `${Math.floor(days / 30)} months ago`;
  return `${Math.floor(days / 365)} years ago`;
}
---

<Layout title="Manage Feeds - RSS Reader">
  <Header />

  <main class="manage-page">
    <h1>Manage Feeds</h1>

    {quietFeeds.length > 0 && (
      <section class="quiet-feeds-section">
        <h2>Quiet feeds ({quietFeeds.length})</h2>
        <p class="section-description">
          These feeds haven't published in over 4 weeks. They may be inactive or the feed URL may have changed.
        </p>

        <ul class="feed-list">
          {quietFeeds.map((feed) => (
            <li class="feed-item quiet">
              <img src={feed.faviconUrl} alt="" class="feed-icon" width="16" height="16" loading="lazy" />
              <div class="feed-info">
                <span class="feed-title">{feed.title}</span>
                <span class="feed-meta">
                  {feed.category} &middot; Last article: {formatLastSeen(feed.lastArticleDate)}
                </span>
              </div>
              <a href={feed.url} target="_blank" rel="noopener noreferrer" class="feed-check-link">
                Check &#8599;
              </a>
            </li>
          ))}
        </ul>
      </section>
    )}

    <section class="active-feeds-section">
      <h2>Active feeds ({activeFeeds.length})</h2>

      <ul class="feed-list">
        {activeFeeds.map((feed) => (
          <li class="feed-item">
            <img src={feed.faviconUrl} alt="" class="feed-icon" width="16" height="16" loading="lazy" />
            <div class="feed-info">
              <span class="feed-title">{feed.title}</span>
              <span class="feed-meta">
                {feed.category} &middot; {formatLastSeen(feed.lastArticleDate)}
                {feed.articleCount > 0 && ` \u00b7 ${feed.articleCount} items`}
              </span>
            </div>
          </li>
        ))}
      </ul>
    </section>

    <section class="custom-feeds">
      <h2>Custom Feeds</h2>
      <p class="section-description">Feeds you added yourself (saved in your browser)</p>
      <div id="custom-feeds-list"></div>
      <button id="export-opml" class="btn-secondary">Export as OPML</button>
    </section>

    <section class="import-section">
      <h2>Import OPML</h2>
      <p>Upload an OPML file to preview its feeds.</p>
      <input type="file" id="opml-upload" accept=".opml,.xml" />
      <div id="import-preview"></div>
    </section>
  </main>
</Layout>

<script>
  import {
    getCustomFeeds,
    removeCustomFeed,
    exportCustomFeedsAsOPML,
  } from '../lib/customFeeds';

  // Show custom feeds
  const customList = document.getElementById('custom-feeds-list');
  const customFeeds = getCustomFeeds();

  if (customFeeds.length === 0) {
    customList!.innerHTML = '<p class="empty">No custom feeds added yet.</p>';
  } else {
    customList!.innerHTML = `
      <ul class="feed-list">
        ${customFeeds
          .map(
            (feed) => `
          <li class="feed-item">
            <div class="feed-info">
              <span class="feed-title">${feed.title}</span>
              <span class="feed-meta">${feed.category} &middot; <code>${feed.url}</code></span>
            </div>
            <button class="remove-feed" data-id="${feed.id}" aria-label="Remove ${feed.title}">&times;</button>
          </li>
        `,
          )
          .join('')}
      </ul>
    `;

    customList!.querySelectorAll('.remove-feed').forEach((btn) => {
      btn.addEventListener('click', () => {
        const id = (btn as HTMLElement).dataset.id!;
        removeCustomFeed(id);
        window.location.reload();
      });
    });
  }

  // Export OPML
  document.getElementById('export-opml')?.addEventListener('click', () => {
    const opml = exportCustomFeedsAsOPML();
    const blob = new Blob([opml], { type: 'application/xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'custom-feeds.opml';
    a.click();
    URL.revokeObjectURL(url);
  });

  // Import OPML preview
  document.getElementById('opml-upload')?.addEventListener('change', async (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (!file) return;

    const text = await file.text();
    const preview = document.getElementById('import-preview')!;

    const matches = text.matchAll(/xmlUrl="([^"]+)"/g);
    const urls = Array.from(matches).map((m) => m[1]);

    preview.innerHTML = `
      <p>Found: ${urls.length} feeds</p>
      <p class="section-description">Copy the OPML file to <code>public/opml/</code> in your repo and rebuild.</p>
    `;
  });
</script>
