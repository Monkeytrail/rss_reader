---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import { getFeedMetadata, getFeedErrors, getCategories, getHiddenFeeds } from '../lib/feeds';

const feeds = await getFeedMetadata();
const feedErrors = await getFeedErrors();
const categories = await getCategories();
const hiddenFeeds = await getHiddenFeeds();

// Group feed metadata by category
const feedsByCategory = new Map<string, typeof feeds>();
for (const cat of categories) {
  const catFeeds = feeds.filter((f) => f.categorySlug === cat.slug);
  if (catFeeds.length > 0) {
    feedsByCategory.set(cat.name, catFeeds);
  }
}

function formatLastSeen(date: Date | null): string {
  if (!date) return 'Never';

  const days = Math.floor((Date.now() - date.getTime()) / 86400000);

  if (days === 0) return 'Today';
  if (days === 1) return 'Yesterday';
  if (days < 7) return `${days} days ago`;
  if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
  if (days < 365) return `${Math.floor(days / 30)} months ago`;
  return `${Math.floor(days / 365)} years ago`;
}
---

<Layout title="Manage Feeds - RSS Reader">
  <Header />

  <main class="manage-page container">
    <h1>Manage Feeds</h1>

    {feedErrors.length > 0 && (
      <section class="feed-errors-section">
        <h2>Feed Errors ({feedErrors.length})</h2>
        <p class="section-description">These feeds failed to load during the last build.</p>
        <ul class="feed-list">
          {feedErrors.map((err) => (
            <li class="feed-item feed-error-item">
              <div class="feed-info">
                <span class="feed-title">{err.title}</span>
                <span class="feed-meta">{err.category}</span>
                <code class="feed-error-message">{err.error}</code>
              </div>
              <a href={err.url} target="_blank" rel="noopener noreferrer" class="btn-secondary">Check</a>
            </li>
          ))}
        </ul>
      </section>
    )}

    {hiddenFeeds.length > 0 && (
      <section class="hidden-feeds-section">
        <h2>Hidden feeds ({hiddenFeeds.length})</h2>
        <p class="section-description">These feeds are hidden from your article list.</p>
        <ul class="feed-list">
          {hiddenFeeds.map((feed) => (
            <li class="feed-item" data-feed-url={feed.url}>
              <div class="feed-info">
                <span class="feed-title">{feed.title}</span>
                <span class="feed-meta">{feed.category}</span>
              </div>
              <button class="restore-feed btn-secondary" data-url={feed.url}>Restore</button>
            </li>
          ))}
        </ul>
      </section>
    )}

    {[...feedsByCategory.entries()].map(([categoryName, catFeeds]) => (
      <section class="feed-category-section">
        <h2>{categoryName} <span class="feed-count">({catFeeds.length})</span></h2>
        <ul class="feed-list">
          {catFeeds.map((feed) => (
            <li class="feed-item" data-feed-url={feed.url} style={feed.isQuiet ? 'border-left: 3px solid rgba(255,200,0,0.6); padding-left: 0.5rem; background: rgba(255,200,0,0.02); border-radius: 4px; opacity: 0.6;' : ''}>
              <img src={feed.faviconUrl} alt="" class="feed-icon" width="16" height="16" loading="lazy" />
              <div class="feed-info">
                <span class="feed-title">{feed.title}</span>
                <span class="feed-meta">
                  {formatLastSeen(feed.lastArticleDate)}
                  {feed.articleCount > 0 && ` \u00b7 ${feed.articleCount} items`}
                  {feed.isQuiet && ' \u00b7 Quiet'}
                </span>
              </div>
              <button class="remove-feed" data-url={feed.url} aria-label={`Hide ${feed.title}`}>&times;</button>
            </li>
          ))}
        </ul>
      </section>
    ))}

    <section class="add-feed-section">
      <h2>Add Feed</h2>
      <form id="add-feed-form" class="add-feed-form visible">
        <div class="form-row">
          <div class="form-group form-group-grow">
            <label for="feed-url">Feed URL</label>
            <input
              type="url"
              id="feed-url"
              name="url"
              placeholder="https://example.com/feed.xml"
              required
            />
          </div>
          <div class="form-group">
            <label for="feed-title">Title (optional)</label>
            <input
              type="text"
              id="feed-title"
              name="title"
              placeholder="Auto-detected"
            />
          </div>
          <div class="form-group">
            <label for="feed-category">Category</label>
            <input type="text" id="feed-category" name="category" value="Custom" list="categories" />
            <datalist id="categories">
              {[...feedsByCategory.keys()].map((name) => (
                <option value={name} />
              ))}
            </datalist>
          </div>
          <div class="form-group form-group-btn">
            <button type="submit" class="btn-primary">Add</button>
          </div>
        </div>
        <p class="form-note">Feed will appear after the next site build.</p>
      </form>
    </section>

    <section class="feed-health-section">
      <h2>Feed Health</h2>
      <p class="section-description">Reliability over recent builds.</p>
      <div id="health-loading" class="feed-meta">Loading health data...</div>
      <div id="health-dashboard" hidden></div>
    </section>

    <section class="manage-actions">
      <h2>Import / Export</h2>
      <div class="opml-buttons">
        <button id="export-opml" class="btn-secondary">Export OPML</button>
        <label for="opml-upload" class="btn-secondary upload-label">Import OPML</label>
        <input type="file" id="opml-upload" accept=".opml,.xml" hidden />
      </div>
      <div id="import-preview"></div>
    </section>
  </main>
</Layout>

<script>
  // --- Hide feed (move to hidden) ---
  document.querySelectorAll<HTMLElement>('.remove-feed[data-url]').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const url = btn.dataset.url!;
      const feedItem = btn.closest<HTMLElement>('.feed-item');
      if (feedItem) feedItem.style.opacity = '0.3';

      try {
        await fetch('/.netlify/functions/manage-feed', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, hidden: true }),
        });
        if (feedItem) feedItem.remove();
      } catch {
        if (feedItem) feedItem.style.opacity = '';
      }
    });
  });

  // --- Restore hidden feed ---
  document.querySelectorAll<HTMLElement>('.restore-feed[data-url]').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const url = btn.dataset.url!;
      const feedItem = btn.closest<HTMLElement>('.feed-item');
      if (feedItem) feedItem.style.opacity = '0.3';

      try {
        await fetch('/.netlify/functions/manage-feed', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, hidden: false }),
        });
        if (feedItem) feedItem.remove();
      } catch {
        if (feedItem) feedItem.style.opacity = '';
      }
    });
  });

  // --- Add feed form ---
  const form = document.getElementById('add-feed-form') as HTMLFormElement;
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const url = formData.get('url') as string;
    let title = formData.get('title') as string;
    const category = (formData.get('category') as string) || 'Custom';
    const categorySlug = category.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');

    if (!title) {
      try {
        const response = await fetch(
          `/.netlify/functions/fetch-feed-info?url=${encodeURIComponent(url)}`,
        );
        if (response.ok) {
          const data = await response.json();
          title = data.title || new URL(url).hostname;
        }
      } catch {
        title = new URL(url).hostname;
      }
    }

    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';

    try {
      const response = await fetch('/.netlify/functions/manage-feed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title,
          url,
          category_name: category,
          category_slug: categorySlug,
        }),
      });

      if (response.ok) {
        submitBtn.textContent = 'Added! Rebuilding...';
        form.reset();
        (document.getElementById('feed-category') as HTMLInputElement).value = 'Custom';
      } else {
        const data = await response.json();
        submitBtn.textContent = data.error || 'Failed';
      }
    } catch {
      submitBtn.textContent = 'Error';
    }

    setTimeout(() => {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Add';
    }, 3000);
  });

  // --- Export OPML (all feeds from page) ---
  document.getElementById('export-opml')?.addEventListener('click', () => {
    const feedItems = document.querySelectorAll<HTMLElement>('.feed-item[data-feed-url]');
    const feedsByCategory = new Map<string, { title: string; url: string }[]>();

    feedItems.forEach((item) => {
      const url = item.dataset.feedUrl!;
      const title = item.querySelector('.feed-title')?.textContent || url;
      const section = item.closest('.feed-category-section');
      const category = section?.querySelector('h2')?.textContent?.replace(/\(\d+\)/, '').trim() || 'Uncategorized';

      if (!feedsByCategory.has(category)) feedsByCategory.set(category, []);
      feedsByCategory.get(category)!.push({ title, url });
    });

    const outlines = [...feedsByCategory.entries()]
      .map(([cat, feeds]) => {
        const children = feeds
          .map((f) => `      <outline type="rss" text="${escapeXml(f.title)}" title="${escapeXml(f.title)}" xmlUrl="${escapeXml(f.url)}" />`)
          .join('\n');
        return `    <outline text="${escapeXml(cat)}" title="${escapeXml(cat)}">\n${children}\n    </outline>`;
      })
      .join('\n');

    const opml = `<?xml version="1.0" encoding="UTF-8"?>
<opml version="2.0">
  <head><title>RSS Reader Feeds</title></head>
  <body>
${outlines}
  </body>
</opml>`;

    const blob = new Blob([opml], { type: 'application/xml' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'feeds.opml';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  function escapeXml(text: string): string {
    return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  // --- Import OPML ---
  document.getElementById('opml-upload')?.addEventListener('change', async (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (!file) return;

    const text = await file.text();
    const preview = document.getElementById('import-preview')!;

    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'application/xml');
    const outlines = doc.querySelectorAll('outline[xmlUrl]');

    const feeds: { title: string; url: string; category: string; categorySlug: string }[] = [];
    outlines.forEach((outline) => {
      const url = outline.getAttribute('xmlUrl')!;
      const title = outline.getAttribute('title') || outline.getAttribute('text') || new URL(url).hostname;
      const parent = outline.parentElement;
      const category = parent?.tagName === 'outline'
        ? (parent.getAttribute('title') || parent.getAttribute('text') || 'Imported')
        : 'Imported';
      const categorySlug = category.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
      feeds.push({ title, url, category, categorySlug });
    });

    if (feeds.length === 0) {
      preview.innerHTML = '<p>No feeds found in this OPML file.</p>';
      return;
    }

    preview.innerHTML = `
      <p>Found ${feeds.length} feed${feeds.length === 1 ? '' : 's'}.</p>
      <button id="confirm-import" class="btn-primary">Import ${feeds.length} feed${feeds.length === 1 ? '' : 's'}</button>
    `;

    document.getElementById('confirm-import')?.addEventListener('click', async () => {
      const btn = document.getElementById('confirm-import') as HTMLButtonElement;
      btn.disabled = true;
      btn.textContent = 'Importing...';

      try {
        const response = await fetch('/.netlify/functions/import-opml', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(feeds),
        });
        const data = await response.json();
        preview.innerHTML = `<p>Imported ${data.imported} feed${data.imported === 1 ? '' : 's'} (${data.skipped} skipped). Rebuilding...</p>`;
      } catch {
        preview.innerHTML = '<p>Import failed.</p>';
      }
    });

    (e.target as HTMLInputElement).value = '';
  });

  // --- Feed Health Dashboard ---
  async function loadFeedHealth() {
    try {
      const response = await fetch('/.netlify/functions/get-feed-health');
      if (!response.ok) throw new Error('Failed');

      const healthData: Record<string, { status: string; errorMessage: string | null }[]> = await response.json();
      const dashboard = document.getElementById('health-dashboard')!;
      const loading = document.getElementById('health-loading')!;

      loading.hidden = true;
      dashboard.hidden = false;

      if (Object.keys(healthData).length === 0) {
        dashboard.innerHTML = '<p class="feed-meta">No health data yet. Data appears after the first build with Turso configured.</p>';
        return;
      }

      const issues: string[] = [];
      for (const [feedUrl, snapshots] of Object.entries(healthData)) {
        const recent = snapshots.slice(0, 5);
        const errorCount = recent.filter((s) => s.status === 'error').length;
        const quietCount = recent.filter((s) => s.status === 'quiet').length;

        if (errorCount === 0 && quietCount === 0) continue;

        let cls = 'health-quiet';
        let msg = 'No recent articles';
        if (errorCount >= 3) {
          cls = 'health-critical';
          msg = `Failed ${errorCount} of last ${recent.length} builds`;
        } else if (errorCount > 0) {
          cls = 'health-warning';
          msg = `${errorCount} error${errorCount === 1 ? '' : 's'} in last ${recent.length} builds`;
        }

        const feedItem = document.querySelector<HTMLElement>(`.feed-item[data-feed-url="${CSS.escape(feedUrl)}"]`);
        const title = feedItem?.querySelector('.feed-title')?.textContent || new URL(feedUrl).hostname;

        issues.push(`<div class="health-item ${cls}"><span class="health-dot"></span><span class="health-title">${title}</span><span class="health-status">${msg}</span></div>`);
      }

      if (issues.length === 0) {
        dashboard.innerHTML = '<p class="feed-meta">All feeds healthy across recent builds.</p>';
      } else {
        dashboard.innerHTML = `<div class="health-grid">${issues.join('')}</div>`;
      }
    } catch {
      document.getElementById('health-loading')!.textContent = 'Health data unavailable.';
    }
  }

  loadFeedHealth();
</script>
