---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
---

<Layout title="Discover Feeds - RSS Reader">
  <Header />

  <main class="container discover-page">
    <h1>Discover Feeds</h1>
    <p class="section-description">
      Feeds discovered from trending stories on Hacker News, Lobste.rs, and Dev.to.
      Subscribe to add them to your reader, or dismiss to hide.
    </p>

    <div id="suggestions-loading" class="loading-state">
      <p>Loading suggestions...</p>
    </div>

    <div id="suggestions-empty" class="empty-state" hidden>
      <p>No suggestions yet. The discovery engine runs every 12 hours â€” check back later!</p>
    </div>

    <div id="suggestions-error" class="error-state" hidden>
      <p>Failed to load suggestions. Please try again later.</p>
    </div>

    <ul id="suggestions-list" class="suggestion-list" hidden></ul>
  </main>
</Layout>

<style>
  .discover-page {
    padding-block: var(--space-lg);
  }

  .section-description {
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
    margin-bottom: var(--space-lg);
  }

  .loading-state,
  .empty-state,
  .error-state {
    text-align: center;
    padding: var(--space-xl);
    color: var(--color-text-secondary);
  }

  .loading-state[hidden],
  .empty-state[hidden],
  .error-state[hidden],
  .suggestion-list[hidden] {
    display: none;
  }

  .suggestion-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
</style>

<style is:global>
  .suggestion-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    padding: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  .suggestion-item:last-child {
    border-bottom: none;
  }

  .suggestion-favicon {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    margin-top: 2px;
    flex-shrink: 0;
  }

  .suggestion-info {
    flex: 1;
    min-width: 0;
  }

  .suggestion-title {
    font-weight: 500;
    font-size: var(--font-size-lg);
    margin-bottom: var(--space-xs);
  }

  .suggestion-domain {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-xs);
  }

  .suggestion-description {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-sm);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .suggestion-meta {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    align-items: center;
  }

  .suggestion-score {
    background: color-mix(in srgb, var(--color-accent) 15%, transparent);
    color: var(--color-accent);
    padding: 0.1em 0.5em;
    border-radius: 3px;
    font-weight: 600;
  }

  .suggestion-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    flex-shrink: 0;
  }

  .btn-subscribe {
    background: var(--color-accent);
    color: white;
    border: none;
    padding: var(--space-sm) var(--space-md);
    border-radius: 4px;
    cursor: pointer;
    font-size: var(--font-size-sm);
    font-family: inherit;
    white-space: nowrap;
  }

  .btn-subscribe:hover {
    opacity: 0.9;
  }

  .btn-subscribe:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-dismiss {
    background: transparent;
    border: 1px solid var(--color-border);
    padding: var(--space-sm) var(--space-md);
    border-radius: 4px;
    cursor: pointer;
    font-size: var(--font-size-sm);
    font-family: inherit;
    color: var(--color-text-secondary);
    white-space: nowrap;
  }

  .btn-dismiss:hover {
    border-color: #e53e3e;
    color: #e53e3e;
  }

  @media (max-width: 600px) {
    .suggestion-item {
      flex-direction: column;
      padding: var(--space-md);
    }

    .suggestion-actions {
      flex-direction: row;
      width: 100%;
    }

    .suggestion-actions button {
      flex: 1;
    }
  }
</style>

<script>
  import { escapeHtml } from '../lib/utils';

  interface Suggestion {
    domain_id: number;
    domain: string;
    feed_url: string;
    feed_title: string;
    feed_description: string | null;
    current_score: number;
    first_seen: string;
    source_count: number;
    categories: string;
  }

  const loadingEl = document.getElementById('suggestions-loading')!;
  const emptyEl = document.getElementById('suggestions-empty')!;
  const errorEl = document.getElementById('suggestions-error')!;
  const listEl = document.getElementById('suggestions-list')!;

  async function loadSuggestions() {
    try {
      const response = await fetch('/.netlify/functions/get-suggestions');
      if (!response.ok) throw new Error('Fetch failed');

      const suggestions: Suggestion[] = await response.json();
      loadingEl.hidden = true;

      if (suggestions.length === 0) {
        emptyEl.hidden = false;
        return;
      }

      listEl.innerHTML = suggestions
        .map(
          (s) => `
        <li class="suggestion-item" data-domain-id="${s.domain_id}">
          <img
            class="suggestion-favicon"
            src="https://www.google.com/s2/favicons?domain=${escapeHtml(s.domain)}&sz=32"
            alt="" width="24" height="24"
          />
          <div class="suggestion-info">
            <div class="suggestion-title">${escapeHtml(s.feed_title || s.domain)}</div>
            <div class="suggestion-domain">${escapeHtml(s.domain)}</div>
            ${s.feed_description ? `<p class="suggestion-description">${escapeHtml(s.feed_description)}</p>` : ''}
            <div class="suggestion-meta">
              <span class="suggestion-score">${s.current_score} pts</span>
              <span>${s.source_count} source${s.source_count !== 1 ? 's' : ''}</span>
              ${s.categories ? s.categories.split(',').map((c: string) => `<span class="category-tag">${escapeHtml(c.trim())}</span>`).join('') : ''}
              <span>First seen: ${new Date(s.first_seen).toLocaleDateString()}</span>
            </div>
          </div>
          <div class="suggestion-actions">
            <button
              class="btn-subscribe"
              data-feed-url="${escapeAttr(s.feed_url)}"
              data-feed-title="${escapeAttr(s.feed_title || s.domain)}"
              data-domain-id="${s.domain_id}"
            >Subscribe</button>
            <button class="btn-dismiss" data-domain-id="${s.domain_id}">Dismiss</button>
          </div>
        </li>
      `,
        )
        .join('');

      listEl.hidden = false;
      attachHandlers();
    } catch {
      loadingEl.hidden = true;
      errorEl.hidden = false;
    }
  }

  function attachHandlers() {
    listEl.querySelectorAll<HTMLButtonElement>('.btn-subscribe').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const domainId = Number(btn.dataset.domainId);
        const feedUrl = btn.dataset.feedUrl!;
        const feedTitle = btn.dataset.feedTitle!;

        const category = prompt('Category for this feed:', 'Discovered') || 'Discovered';
        const categorySlug = category
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');

        btn.disabled = true;
        btn.textContent = 'Subscribing...';

        try {
          const response = await fetch('/.netlify/functions/subscribe-feed', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              domain_id: domainId,
              feed_url: feedUrl,
              feed_title: feedTitle,
              category,
              category_slug: categorySlug,
            }),
          });

          if (response.ok) {
            btn.textContent = 'Subscribed!';
            btn.style.background = '#48bb78';
            btn.closest('.suggestion-item')?.querySelector('.btn-dismiss')?.remove();
          } else {
            const data = await response.json();
            btn.textContent = data.error || 'Failed';
            setTimeout(() => {
              btn.textContent = 'Subscribe';
              btn.disabled = false;
            }, 2000);
          }
        } catch {
          btn.textContent = 'Error';
          setTimeout(() => {
            btn.textContent = 'Subscribe';
            btn.disabled = false;
          }, 2000);
        }
      });
    });

    listEl.querySelectorAll<HTMLButtonElement>('.btn-dismiss').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const domainId = Number(btn.dataset.domainId);
        const item = btn.closest('.suggestion-item') as HTMLElement;

        try {
          const response = await fetch('/.netlify/functions/dismiss-feed', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ domain_id: domainId }),
          });

          if (response.ok) {
            item.style.opacity = '0';
            item.style.transition = 'opacity 0.3s';
            setTimeout(() => item.remove(), 300);

            setTimeout(() => {
              if (listEl.children.length === 0) {
                listEl.hidden = true;
                emptyEl.hidden = false;
              }
            }, 350);
          }
        } catch {
          // silently fail
        }
      });
    });
  }


  function escapeAttr(text: string): string {
    return text
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  loadSuggestions();
</script>
