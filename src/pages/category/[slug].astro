---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import CategoryNav from '../../components/CategoryNav.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import VideoCard from '../../components/VideoCard.astro';
import { fetchAllFeeds, getCategories } from '../../lib/feeds';
import { getDayLabel } from '../../lib/utils';

export async function getStaticPaths() {
  const categories = await getCategories();
  return categories.map((cat) => ({
    params: { slug: cat.slug },
    props: { categoryName: cat.name },
  }));
}

const { slug } = Astro.params;
const { categoryName } = Astro.props;

const allArticles = await fetchAllFeeds();
const articles = allArticles.filter((a) => a.categorySlug === slug);

// Group articles by day
const dayGroups = new Map<string, typeof articles>();
for (const article of articles) {
  const label = getDayLabel(article.pubDate);
  if (!dayGroups.has(label)) {
    dayGroups.set(label, []);
  }
  dayGroups.get(label)!.push(article);
}
---

<Layout title={`${categoryName} - RSS Reader`}>
  <Header />
  <CategoryNav activeSlug={slug} />

  <main class="container">
    <h1>{categoryName}</h1>

    <div class="article-list">
      {[...dayGroups.entries()].map(([dayLabel, dayArticles], index) => (
        <section class="day-group" data-day-index={index} hidden={index >= 3}>
          <h2 class="day-label">{dayLabel}</h2>
          {dayArticles.map((article) => (
            article.mediaType === 'video' ? (
              <VideoCard
                id={article.id}
                title={article.title}
                link={article.link}
                pubDate={article.pubDate}
                summary={article.summary}
                feedUrl={article.feedUrl}
                feedTitle={article.feedTitle}
                feedFavicon={article.feedFavicon}
                category={article.category}
                categorySlug={article.categorySlug}
                thumbnail={article.thumbnail}
                videoId={article.videoId}
              />
            ) : (
              <ArticleCard
                id={article.id}
                title={article.title}
                link={article.link}
                pubDate={article.pubDate}
                summary={article.summary}
                feedUrl={article.feedUrl}
                feedTitle={article.feedTitle}
                feedFavicon={article.feedFavicon}
                category={article.category}
                categorySlug={article.categorySlug}
                readingTime={article.readingTime}
              />
            )
          ))}
        </section>
      ))}

      {dayGroups.size > 3 && (
        <div class="load-more-container">
          <button id="load-more-btn" class="btn-secondary load-more-btn">
            Show older ({dayGroups.size - 3} more days)
          </button>
        </div>
      )}
    </div>

    {articles.length === 0 && (
      <p class="no-results">No articles found in this category.</p>
    )}
  </main>

  <script>
    const loadMoreBtn = document.getElementById('load-more-btn');
    if (loadMoreBtn) {
      const LOAD_INCREMENT = 5;
      let currentlyVisible = 3;
      const allDayGroups = document.querySelectorAll<HTMLElement>('.day-group[data-day-index]');
      const totalDays = allDayGroups.length;

      loadMoreBtn.addEventListener('click', () => {
        const nextBatch = Math.min(currentlyVisible + LOAD_INCREMENT, totalDays);
        for (let i = currentlyVisible; i < nextBatch; i++) {
          allDayGroups[i].hidden = false;
        }
        currentlyVisible = nextBatch;

        const remaining = totalDays - currentlyVisible;
        if (remaining <= 0) {
          loadMoreBtn.style.display = 'none';
        } else {
          loadMoreBtn.textContent = `Show older (${remaining} more day${remaining === 1 ? '' : 's'})`;
        }
      });
    }
  </script>
</Layout>
