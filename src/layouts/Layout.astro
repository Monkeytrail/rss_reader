---
import '../styles/global.css';
import ReaderModal from '../components/ReaderModal.astro';

interface Props {
  title?: string;
  description?: string;
}

const { title = 'RSS Reader', description = 'Minimale RSS reader' } = Astro.props;
const buildTime = new Date().toISOString();
---

<!doctype html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />

    <!-- PWA -->
    <meta name="theme-color" content="#0066cc" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Reader" />
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png" />
    <link rel="manifest" href="/manifest.json" />

    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <title>{title}</title>

    <script is:inline>
      // Apply saved theme before render to prevent flash
      const t = localStorage.getItem('theme');
      if (t) document.documentElement.setAttribute('data-theme', t);
    </script>
  </head>
  <body>
    <slot />

    <footer class="site-footer">
      <p>
        Last updated: <time datetime={buildTime} id="build-time">{
          new Date(buildTime).toLocaleString('nl-NL', {
            dateStyle: 'medium',
            timeStyle: 'short',
          })
        }</time>
      </p>
    </footer>

    <ReaderModal />

    <script>
      // Register service worker and force update check
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').then((reg) => {
          reg.update();
        });
      }

      // Read status tracking
      import { isRead, markAsRead } from '../lib/readStatus';

      // Mark already-read articles on load
      document.querySelectorAll<HTMLElement>('[data-article-id]').forEach((card) => {
        if (isRead(card.dataset.articleId!)) {
          card.classList.add('is-read');
        }
      });

      // Mark as read when clicking article link or read-in-app
      document.addEventListener('click', (e) => {
        const link = (e.target as Element).closest('.article-title a');
        const readBtn = (e.target as Element).closest('.read-in-app');
        const target = link || readBtn;
        if (!target) return;

        const card = target.closest<HTMLElement>('[data-article-id]');
        if (!card) return;

        markAsRead(card.dataset.articleId!);
        card.classList.add('is-read');
      });
    </script>
  </body>
</html>
