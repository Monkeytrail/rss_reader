---
import Search from './Search.astro';
import ThemeToggle from './ThemeToggle.astro';
import RefreshButton from './RefreshButton.astro';
---

<header class="site-header">
  <a href="/" class="logo">Reader</a>

  <Search />

  <nav class="header-nav">
    <RefreshButton />
    <div class="header-menu">
      <button class="header-menu-btn" aria-label="Menu" aria-expanded="false">&#xFE19;</button>
      <div class="header-dropdown" hidden>
        <a href="/discover">Discover</a>
        <a href="/#saved">Saved</a>
        <a href="/manage">Feeds</a>
        <ThemeToggle />
        <button class="logout-btn" id="logout-btn" aria-label="Log out">Logout</button>
      </div>
    </div>
  </nav>
</header>

<script>
  const menuBtn = document.querySelector('.header-menu-btn');
  const dropdown = document.querySelector('.header-dropdown') as HTMLElement;

  menuBtn?.addEventListener('click', () => {
    const open = !dropdown.hidden;
    dropdown.hidden = open;
    menuBtn.setAttribute('aria-expanded', String(!open));
  });

  document.addEventListener('click', (e) => {
    if (!(e.target as Element).closest('.header-menu')) {
      dropdown.hidden = true;
      menuBtn?.setAttribute('aria-expanded', 'false');
    }
  });

  document.getElementById('logout-btn')?.addEventListener('click', () => {
    const w = window as any;
    if (w.netlifyIdentity) {
      w.netlifyIdentity.logout();
      w.netlifyIdentity.on('logout', () => {
        window.location.replace('/login');
      });
    } else {
      localStorage.removeItem('gotrue.user');
      window.location.replace('/login');
    }
  });
</script>
