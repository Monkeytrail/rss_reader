---
import Search from './Search.astro';
import ThemeToggle from './ThemeToggle.astro';
import RefreshButton from './RefreshButton.astro';
---

<header class="site-header">
  <a href="/" class="logo">Reader</a>

  <Search />

  <nav class="header-nav">
    <RefreshButton />
    <a href="/discover">Discover</a>
    <a href="/#saved" class="saved-link">Saved <span id="bookmark-count" class="badge"></span></a>
    <a href="/manage">Feeds</a>
    <ThemeToggle />
    <button class="logout-btn" id="logout-btn" aria-label="Log out">Logout</button>
  </nav>
</header>

<script>
  import { getBookmarkCount } from '../lib/bookmarks';

  function updateBookmarkBadge() {
    const badge = document.getElementById('bookmark-count');
    if (badge) {
      const count = getBookmarkCount();
      badge.textContent = count > 0 ? String(count) : '';
    }
  }

  updateBookmarkBadge();

  document.addEventListener('click', (e) => {
    if ((e.target as Element).closest('.bookmark-button')) {
      setTimeout(updateBookmarkBadge, 0);
    }
  });

  document.getElementById('logout-btn')?.addEventListener('click', () => {
    const w = window as any;
    if (w.netlifyIdentity) {
      w.netlifyIdentity.logout();
      w.netlifyIdentity.on('logout', () => {
        window.location.replace('/login');
      });
    } else {
      localStorage.removeItem('gotrue.user');
      window.location.replace('/login');
    }
  });
</script>
