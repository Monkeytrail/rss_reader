---
// Client-side only component
---

<div class="add-feed">
  <button class="add-feed-toggle" aria-expanded="false" aria-controls="add-feed-form">
    + Add Feed
  </button>

  <form id="add-feed-form" class="add-feed-form" hidden>
    <div class="form-group">
      <label for="feed-url">Feed URL</label>
      <input
        type="url"
        id="feed-url"
        name="url"
        placeholder="https://example.com/feed.xml"
        required
      />
    </div>

    <div class="form-group">
      <label for="feed-title">Title (optional)</label>
      <input
        type="text"
        id="feed-title"
        name="title"
        placeholder="Auto-detected if left empty"
      />
    </div>

    <div class="form-group">
      <label for="feed-category">Category</label>
      <input type="text" id="feed-category" name="category" value="Custom" list="categories" />
      <datalist id="categories"></datalist>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-primary">Add Feed</button>
      <button type="button" class="btn-secondary add-feed-cancel">Cancel</button>
    </div>

    <p class="form-note">Feed will appear after the next site build.</p>
  </form>
</div>

<script>
  const toggle = document.querySelector('.add-feed-toggle');
  const form = document.getElementById('add-feed-form') as HTMLFormElement;
  const cancel = document.querySelector('.add-feed-cancel');

  toggle?.addEventListener('click', () => {
    const expanded = toggle.getAttribute('aria-expanded') === 'true';
    toggle.setAttribute('aria-expanded', String(!expanded));
    form.hidden = expanded;
  });

  cancel?.addEventListener('click', () => {
    toggle?.setAttribute('aria-expanded', 'false');
    form.hidden = true;
    form.reset();
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    let url = formData.get('url') as string;
    let title = formData.get('title') as string;
    let category = (formData.get('category') as string) || 'Custom';

    const isYouTube = url.includes('youtube.com/');

    // Convert YouTube channel URL to feed URL
    if (isYouTube && !url.includes('/feeds/')) {
      try {
        const response = await fetch(
          `/.netlify/functions/youtube-channel-id?url=${encodeURIComponent(url)}`,
        );
        if (response.ok) {
          const data = await response.json();
          url = data.feedUrl;
          if (!title) title = data.channelName;
        }
      } catch (error) {
        console.error('Could not convert YouTube URL:', error);
      }
    }

    // Auto-set YouTube category
    if (isYouTube || url.includes('youtube.com/feeds/')) {
      category = 'YouTube';
    }

    if (!title) {
      try {
        const response = await fetch(
          `/.netlify/functions/fetch-feed-info?url=${encodeURIComponent(url)}`,
        );
        if (response.ok) {
          const data = await response.json();
          title = data.title || new URL(url).hostname;
        }
      } catch {
        title = new URL(url).hostname;
      }
    }

    const categorySlug = category
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '');

    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';

    try {
      const response = await fetch('/.netlify/functions/manage-feed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title,
          url,
          category_name: category,
          category_slug: categorySlug,
        }),
      });

      if (response.ok) {
        submitBtn.textContent = 'Added! Rebuilding...';
        form.reset();
      } else {
        const data = await response.json();
        submitBtn.textContent = data.error || 'Failed';
      }
    } catch {
      submitBtn.textContent = 'Error';
    }

    setTimeout(() => {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Add Feed';
    }, 3000);
  });
</script>
